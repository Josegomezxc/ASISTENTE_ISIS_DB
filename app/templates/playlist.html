<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %} 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chill Vibe Playlist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
    <link rel="stylesheet" href="{% static 'css/playlist.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- SweetAlert2 -->
</head>
<body>
    <style>
        body {
            background-image: url('{% static "images/cielo_3.jpg" %}');
            background-size: cover;
            background-position: center;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: row;
            height: 100vh;
        }
    </style>
    
    <div class="playlist-container">
        <button class="back-button" onclick="window.location.href='{% url 'home' %}'"><i class="fas fa-arrow-left"></i></button>

        <div class="header">
            <img src="{% static 'images/cielo_3.jpg' %}" alt="Playlist Cover" class="cover">
            <div class="info">
                <h1>Chill Vibe Playlist ðŸ˜´</h1>
                <p>$ Contact ig @musicboy_p for requests | Indie pop and lofi chill vibe playlist. No skips | chill vibe, relaxing music, indie music, tik tok music, laying in bed music, homework music, lofi.</p>
                <p><strong>Musicboy_p</strong> â€¢ 1,759 veces guardada â€¢ 122 canciones, cerca de 6 h 30 min</p>
            </div>
        </div>

        <div class="controls-container">
            <button id="playlistBtn" class="play-button" onclick="handlePlaylistChoice()">
                <i class="fas fa-play"></i>
            </button>
            <button id="artistSongsBtn" class="play-button" onclick="playRandomArtistSong()" style="display: none;">
                <i class="fas fa-play"></i>
            </button>
        </div>
        
        <table id="songTable">
            <tr>
                <th>#</th>
                <th>TÃ­tulo</th>
                <th>Artista</th>
            </tr>
            {% for song in user_songs %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>
                    <div style="display: flex; align-items: center;">
                        <img id="img-{{ forloop.counter }}" src="{% static 'images/ciudad_3.jpg' %}" alt="Foto de la canciÃ³n" style="width: 70px; height: 70px; cursor: pointer; margin-right: 10px;" onclick="playSong('{{ song.url }}', '{{ song.song_name }}', '{{ song.artist_name }}')">
                        <span>{{ song.song_name }}</span>
                    </div>
                </td>
                <td>{{ song.artist_name }}</td>
            </tr>
            {% endfor %}
        </table>
        {% if user_songs|length == 0 %} <!-- Verifica si no hay canciones -->
        <div class="alert alert-info" style="text-align: center; margin-top: 20px;">
            <strong>No hay canciones en la lista.</strong>
        </div>
        {% endif %}
    </div>

    <script>
        const canciones = []; // Arreglo para almacenar las canciones
        let currentSongIndex = 0; // Ãndice de la canciÃ³n actual
        const ELEVEN_LABS_API_KEY = "sk_9e4e59be228718c14e779355ec95b867467c28c491003ddd";
        const ELEVEN_LABS_VOICE_ID = "JEzse6GMhKZ6wrVNFZTq";

        // Obtener canciones de la tabla
        document.querySelectorAll('#songTable tr').forEach((row, index) => {
            if (index > 0) { // Ignorar la fila de encabezado
                const cells = row.querySelectorAll('td');
                const song = {
                    title: cells[1].innerText,
                    artist: cells[2].innerText,
                    url: cells[1].querySelector('img').getAttribute('onclick').match(/'(.*?)'/)[1] // Extraer la URL desde el evento onclick de la imagen
                };
                canciones.push(song);
            }
        });

        // Frases para que Aria hable
        const frasesDJ = [
            `Â¡Hey! Â¿Listo para una sesiÃ³n llena de buena mÃºsica? Hoy tengo algo especial para ti, algo que encaja perfecto con tu vibe. La primera melodÃ­a que va a sonar es {songName}. Cierra los ojos, siente el ritmo y deja que la mÃºsica haga su magia.`,
            "Me encanta ver que te conectas con estos sonidos. No hay nada mejor que compartir buena mÃºsica con alguien que realmente la disfruta. Vamos a seguir explorando juntos.",
            `Escucha estoâ€¦ Es el inicio de algo increÃ­ble. {songName} marca el comienzo de un viaje sonoro que te va a transportar a otro lugar. No importa dÃ³nde estÃ©s, deja que la mÃºsica te guÃ­e.`,
            "Siento que estÃ¡s disfrutando esta selecciÃ³n. Â¿Sabes quÃ© es lo mejor? Que apenas estamos empezando. Esto solo irÃ¡ subiendo de nivel, asÃ­ que prepÃ¡rate.",
            `AtenciÃ³n, amantes del buen sonido. La sesiÃ³n de hoy arranca con una joya que te va a encantar: {songName}. La elegÃ­ especialmente porque sÃ© que te gusta este tipo de vibe. Sube el volumen y dÃ©jate llevar.`,
            "Parece que esta mÃºsica realmente resuena contigo. Eso me encanta. Vamos a seguir explorando mÃ¡s sonidos que te hagan vibrar.",
            `AquÃ­ viene algo espectacular. {songName} es el primer paso de este recorrido musical. Siente cada acorde, cada beat, y deja que la energÃ­a fluya a travÃ©s de ti.`,
            "Nada mejor que una buena melodÃ­a para acompaÃ±ar el momento. QuÃ©date aquÃ­, porque lo que sigue te va a sorprender aÃºn mÃ¡s.",
            `Busca un buen lugar, relÃ¡jate y prepÃ¡rate. Este track, {songName}, es el arranque perfecto para esta sesiÃ³n. Deja que la mÃºsica te envuelva y transforme tu dÃ­a.`,
            "Veo que tienes un gusto musical increÃ­ble. Eso me motiva a seguir trayÃ©ndote lo mejor de lo mejor. Â¿Listo para lo que sigue?",
            `Dale play a este instante, deja todo atrÃ¡s y solo disfruta. Para empezar con la mejor vibra, aquÃ­ estÃ¡ {songName}. Este sonido es justo lo que necesitas en este momento.`,
            "Este estilo realmente parece ir contigo. Me encanta ver cÃ³mo te sumerges en cada nota. Vamos a seguir construyendo esta atmÃ³sfera juntos.",
            `Cierra los ojos, respira profundo y siente cada nota. {songName} es el inicio de este viaje sonoro que he preparado para ti. No hay prisa, solo fluye con el ritmo.`,
            "Parece que esta mÃºsica realmente te atrapa. Eso es lo hermoso de los sonidos: nos conectan sin necesidad de palabras. Sigamos adelante, porque lo mejor estÃ¡ por venir.",
            `Es momento de sumergirte en la mÃºsica. {songName} es el punto de partida, y de aquÃ­ en adelante, todo serÃ¡ una experiencia Ãºnica. DÃ©jate llevar y disfruta el camino.`,
            "Siento que esta melodÃ­a te habla de una forma especial. Y eso es justo lo que quiero: que cada canciÃ³n que suene aquÃ­ tenga un significado para ti.",
            `AquÃ­ va el primer sonido de la noche. {songName} marca el inicio de esta experiencia musical. No importa si bailas, cantas o simplemente te dejas llevar, lo importante es sentirlo.`,
            "Es genial verte disfrutando de esta sesiÃ³n. Para eso estamos aquÃ­: para encontrar juntos los mejores sonidos que te acompaÃ±en en cada momento.",
            `Escucha con atenciÃ³nâ€¦ AsÃ­ es como todo empieza. {songName} es solo la primera parada en este viaje musical. Te prometo que lo que sigue te va a encantar.`,
            "Veo que conectas con este ritmo. Â¡Eso es increÃ­ble! Vamos a seguir con mÃ¡s canciones que se sientan tan bien como esta.",
        ];

        async function handlePlaylistChoice() {
            if (canciones.length === 0) { // Verificar si no hay canciones
                await speakWithAria("Â¡Oh, no! Parece que tu lista de canciones estÃ¡ vacÃ­a en este momento. Â¿QuÃ© te parece si la llenamos con algunas de tus melodÃ­as favoritas? Estoy aquÃ­ para ayudarte a descubrir y crear la mejor Playlist para tus momentos especiales. Â¡Vamos a hacerlo juntos!. Ve a la pÃ¡gina de inicio, presiona el micrÃ³fono y di el comando para reproducir la mÃºsica de tu cantante o artista favorito ");
                return; // Salir de la funciÃ³n
            }
            const esperar = (segundos) => new Promise(resolve => setTimeout(resolve, segundos * 1000));
            // Pregunta al usuario quÃ© opciÃ³n prefiere
            const question = "Â¿Quieres escuchar las canciones de tu playlist o que elija canciones basadas en tus Ãºltimas canciones escuchadas?";
            await speakWithAria("Â¿QuÃ© quieres hacer?. "+question); // Aria dice la pregunta

            const { value: choice } = await Swal.fire({
                title: 'Â¿QuÃ© quieres hacer?',
                text: question,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Escuchar Playlist',
                cancelButtonText: 'Elige Canciones'
            });

            if (choice) {
                await speakWithAria("Ok entonces, reproduzcamos tus canciones favoritas de tu playlist.");
                await esperar(4.5);
                // Esperar a que termine de hablar antes de iniciar
                await playNextSong();
            } else {
                await speakWithAria("Ok, entonces empecemos con unos temas elegidos por mÃ­ que seguro te van a gustar.");
                await esperar(4.5);
                // Esperar a que termine de hablar antes de iniciar
                await playRandomArtistSong();
            }
        }

        async function playNextSong() {
            if (currentSongIndex >= canciones.length) {
                await askToContinueListening()
                return;
            }

            const song = canciones[currentSongIndex];
            const videoId = song.url.split('v=')[1]; 
            const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;

            // Obtener duraciÃ³n de la canciÃ³n
            const videoDetailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${videoId}&key=AIzaSyDaV1StCzjDs6ga_L8pRUYNgf9Sbq3BpAo`;
            const videoDetailsResponse = await fetch(videoDetailsUrl);
            const videoDetailsData = await videoDetailsResponse.json();

            let duration = 30000; // DuraciÃ³n predeterminada de 30 segundos
            if (videoDetailsData.items && videoDetailsData.items.length > 0) {
                const videoDuration = videoDetailsData.items[0].contentDetails.duration; // Formato ISO 8601
                const match = videoDuration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
                const hours = (match[1] ? parseInt(match[1]) : 0) * 3600;
                const minutes = (match[2] ? parseInt(match[2]) : 0) * 60;
                const seconds = (match[3] ? parseInt(match[3]) : 0);
                duration = hours + minutes + seconds; // Total en segundos
            }

            // Abrir la canciÃ³n en una nueva pestaÃ±a
            window.open(videoUrl, '_blank');

            // Hablar con la voz de Eleven Labs
            let availableFrases = [...frasesDJ];
            const randomFraseIndex = Math.floor(Math.random() * availableFrases.length);
            const frase = availableFrases[randomFraseIndex].replace("{songName}", song.title); // Reemplazar con el nombre de la canciÃ³n
            await speakWithAria(frase); // Usar la frase para que Aria hable

            currentSongIndex++; // Pasar a la siguiente canciÃ³n

            // Esperar a que termine la canciÃ³n antes de reproducir la siguiente
            setTimeout(playNextSong, duration * 1000); // Convertir a milisegundos
        }

        let currentArtistIndex = 0; // Ãndice del artista actual
        let uniqueArtists = new Set(); // Almacena artistas Ãºnicos

        async function playRandomArtistSong() {
            // AsegÃºrate de que solo haya una canciÃ³n por artista
            if (currentArtistIndex >= canciones.length) {
                await askToContinueListening(); // Preguntar si quieren continuar despuÃ©s de reproducir todas las canciones
                return;
            }

            const song = canciones[currentArtistIndex];
            const artista = song.artist;

            // Busca canciones del mismo artista usando la API de YouTube
            const query = `${artista} canciones`;
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&maxResults=20&key=AIzaSyDaV1StCzjDs6ga_L8pRUYNgf9Sbq3BpAo`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                // Filtrar canciones del mismo artista
                const cancionesRelacionadas = data.items.filter(item =>
                    item.snippet.channelTitle.toLowerCase() === artista.toLowerCase()
                );

                if (cancionesRelacionadas.length > 0) {
                    const randomRelatedIndex = Math.floor(Math.random() * cancionesRelacionadas.length);
                    const relatedSong = cancionesRelacionadas[randomRelatedIndex];

                    const relatedVideoId = relatedSong.id.videoId;
                    const relatedVideoUrl = `https://www.youtube.com/watch?v=${relatedVideoId}`;

                    // Abrir la canciÃ³n en una nueva pestaÃ±a
                    window.open(relatedVideoUrl, '_blank');

                    // Hablar con la voz de Eleven Labs
                    let availableFrases = [...frasesDJ];
                    const frase = availableFrases[Math.floor(Math.random() * availableFrases.length)].replace("{songName}", relatedSong.snippet.title);
                    await speakWithAria(frase);

                    // Obtener duraciÃ³n de la canciÃ³n
                    const videoDetailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${relatedVideoId}&key=AIzaSyDaV1StCzjDs6ga_L8pRUYNgf9Sbq3BpAo`;
                    const videoDetailsResponse = await fetch(videoDetailsUrl);
                    const videoDetailsData = await videoDetailsResponse.json();

                    let duration = 300; // DuraciÃ³n predeterminada de 5 minutos
                    if (videoDetailsData.items && videoDetailsData.items.length > 0) {
                        const videoDuration = videoDetailsData.items[0].contentDetails.duration;
                        const match = videoDuration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
                        const hours = (match[1] ? parseInt(match[1]) : 0) * 3600;
                        const minutes = (match[2] ? parseInt(match[2]) : 0) * 60;
                        const seconds = (match[3] ? parseInt(match[3]) : 0);
                        duration = hours + minutes + seconds;
                    }

                    currentArtistIndex++; // Pasar al siguiente artista

                    // Esperar a que termine la canciÃ³n y luego reproducir otra
                    setTimeout(playRandomArtistSong, duration * 1000);
                } else {
                    await speakWithAria(`No se encontraron canciones del artista ${artista}.`);
                    currentArtistIndex++; // Pasar al siguiente artista
                    await playRandomArtistSong(); // Intentar con otro artista
                }
            } catch (error) {
                console.error("Error al buscar canciones del artista:", error);
                await speakWithAria("Hubo un error al buscar canciones. IntentarÃ© de nuevo.");
                currentArtistIndex++; // Pasar al siguiente artista
                await playRandomArtistSong();
            }
        }

        async function askToContinueListening() {
            const question_2 = "Â¿Quieres seguir escuchando?";
            await speakWithAria("Ya hemos terminado todas las canciones de los artistas disponibles. "+question_2);
            const { value: continueListening } = await Swal.fire({
                title: 'Â¿Quieres seguir escuchando?',
                text: 'Ya hemos terminado todas las canciones de los artistas disponibles.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'SÃ­',
                cancelButtonText: 'No'
            });

            if (continueListening) {
                currentArtistIndex = 0; // Reiniciar Ã­ndice de artistas
                await speakWithAria("Â¡Genial Vamos a continuar con mÃ¡s mÃºsica!.");
                await playRandomArtistSong(); // Reiniciar la reproducciÃ³n
            } else {
                await speakWithAria("Â¡Gracias por escuchar. Hasta la prÃ³xima!");
            }
        }


        async function speakWithAria(text) {
            try {
                const response = await fetch("https://api.elevenlabs.io/v1/text-to-speech/" + ELEVEN_LABS_VOICE_ID, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "xi-api-key": ELEVEN_LABS_API_KEY
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.8
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error("Error al obtener el audio");
                }
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
            } catch (error) {
                console.error("Error al reproducir la voz de Aria:", error);
                speakWithDefaultVoice(text);
            }
            function speakWithDefaultVoice(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES'; // Establece el idioma, por ejemplo, espaÃ±ol de EspaÃ±a
                window.speechSynthesis.speak(utterance);
            }
        }
    </script>
</body>
</html>
